{% extends "base.html" %}

{% block title %}Galeri{% endblock %}

{% block content %}
    <div class="container">
        <div class="card">
            <h1 class="card-title">Unggah Gambar Baru</h1>
            <form method="post" enctype="multipart/form-data" action="{{ url_for('gallery') }}" class="form-upload">
                <div class="form-group">
                    <label for="files" class="file-upload-label">
                        <h3> Masukan Item</h3>
                    </label>
                    <input type="file" name="files" id="file-upload" accept=".png, .jpg, .jpeg, .gif" required multiple>
                </div>
                <div class="form-group">
                    <input type="text" name="description" placeholder="Deskripsi gambar (opsional)">
                </div>
                <div class="form-group">
                    <label for="category">Kategori:</label>
                    <select name="category" id="category">
                        <option value="none">Tidak ada kategori</option>
                        {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
   			{% for folder in cloudinary_folder %}
    			<option value="{{ folder }}">{{ folder }} (Cloudinary)</option>
    			{% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <input type="text" name="tags" placeholder="Tag (pisahkan dengan koma)">
                </div>
                <button type="submit" class="btn btn-primary">Unggah</button>
            </form>
        </div>

        <div class="card">
            <h3 class="card-title">Cari dan Filter</h3>
                <div class="form-group">
            <form method="get" action="{{ url_for('gallery') }}" class="search-bar">
                <input type="text" name="search" placeholder="Cari..." value="{{ search_query }}">
                </div>
                <div class="form-group">
                <select name="category_id">
                    <option value="">Semua Kategori</option>
                    {% for category in categories %}
                        <option value="{{ category.id }}" {% if selected_category_id == category.id %}selected{% endif %}>
                            {{ category.name }}
                        </option>
                    {% endfor %}
                </select>
                </div>
                <div class="form-group">
                <select name="tag">
                    <option value="">Semua Tag</option>
                    {% for tag in all_tags %}
                        <option value="{{ tag.name }}" {% if selected_tag == tag.name %}selected{% endif %}>
                            {{ tag.name }}
                        </option>
                    {% endfor %}
                </select>
		</div>
                <div class="form-group">
                <button type="submit" class="btn btn-secondary">Cari</button>
            </form>
        </div>
	</div>
        <div class="gallery">
            {% if image_files %}
                {% for image in image_files %}
                <div class="card gallery-item">
                    <img class="combrok" src="{{ image.secure_url }}" data-src="{{ image.secure_url }}" alt="{{ image.description }}">
                    <p class="image-description">{{ image.description }}</p>
                    
                    <div class="image-meta">
                        {% if image.category %}
                            <p class="image-category">Kategori: <a href="{{ url_for('gallery', category_id=image.category.id) }}">{{ image.category.name }}</a></p>
                        {% endif %}
                        {% if image.tags %}
                            <p class="image-tags">Tag: 
                            {% for tag in image.tags %}
                                <a href="{{ url_for('gallery', tag=tag.name, search=search_query, category_id=selected_category_id) }}" class="tag">{{ tag.name }}</a>
                            {% endfor %}
                            </p>
                        {% endif %}
                    </div>
                    
                <div class="like-section">
                    <button type="button" class="like-button btn" data-image-id="{{ image.id }}">
                        <svg class="heart-icon"
                             data-liked="{% if current_user.is_authenticated and current_user.has_liked_image(image) %}true{% else %}false{% endif %}"
                             xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                             >
                            <path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"></path>
                        </svg>
                        <span class="like-count" data-image-id="{{ image.id }}">{{ image.likes|length }}</span>
                    </button>
                                        
                        {% if current_user.is_authenticated and (current_user.is_admin or current_user.id == image.uploader.id) %}
                            <form action="{{ url_for('delete_image', image_id=image.id) }}" method="post" style="display:inline;">
                                <button type="submit" class="btn btn-danger">Hapus</button>
                            </form>
                        {% endif %}

                        {% if current_user.is_authenticated and current_user.id == image.uploader.id %}
                        <a href="{{ url_for('edit_image', image_id=image.id) }}" class="btn btn-secondary">Edit</a>
                        {% endif %}
                    </div>
                    
                    <div class="comments">
                        <h4>Komentar ({{ image.comments|length }})</h4>
                        <div class="comments-list">
                        {% for comment in image.comments %}
                            <p class="comment-item">
                                <strong><a href="{{ url_for('user_profile', username=comment.commenter.username) }}">{{ comment.commenter.username }}</a></strong>: {{ comment.content }}
                                {% if current_user.is_authenticated and (current_user.is_admin or current_user.id == comment.commenter.id) %}
                                    <form action="{{ url_for('delete_comment', comment_id=comment.id) }}" method="post" class="delete-comment-form">
                                        <button type="submit" class="btn btn-danger btn-small">Hapus</button>
                                    </form>
                                {% endif %}
                            </p>
                        {% endfor %}
                        </div>
                        <form method="post" action="{{ url_for('comment_image', image_id=image.id) }}" id="comment-form" class="comment-form">
                            <textarea name="content" placeholder="Tambahkan komentar..." required></textarea>
                            <button type="submit" class="btn btn-primary">Kirim Komentar</button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p>Upload Gambar Dulu Gengs.</p>
            {% endif %}
        </div>
       </div>
{% endblock %}
{% block scripts %}
<script src="{{ url_for('static', filename='js/ajax.js') }}"></script>
{% endblock %}
